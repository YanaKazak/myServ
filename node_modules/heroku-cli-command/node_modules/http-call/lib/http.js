'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _getIterator2 = require('babel-runtime/core-js/get-iterator');

var _getIterator3 = _interopRequireDefault(_getIterator2);

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _util = require('util');

var _util2 = _interopRequireDefault(_util);

var _url = require('url');

var _url2 = _interopRequireDefault(_url);

var _package = require('../package.json');

var _package2 = _interopRequireDefault(_package);

var _http = require('http');

var _http2 = _interopRequireDefault(_http);

var _https = require('https');

var _https2 = _interopRequireDefault(_https);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function concat(stream) {
  return new _promise2.default(function (resolve) {
    var strings = [];
    stream.on('data', function (data) {
      return strings.push(data);
    });
    stream.on('end', function () {
      return resolve(strings.join(''));
    });
  });
}

/**
 * @typedef {Object} RequestOptions
 * @property {Object.<string, string>} headers - request headers
 * @property {string} method - request method (GET/POST/etc)
 * @property {(string)} body - request body. Sets content-type to application/json and stringifies when object
 */

/* global
  http$IncomingMessage
*/

/**
 * Utility for simple HTTP calls
 * @class
 */
var HTTP = function () {
  (0, _createClass3.default)(HTTP, null, [{
    key: 'get',

    /**
     * make an http GET request
     * @param {string} url - url or path to call
     * @param {RequestOptions} options
     * @returns {Promise}
     * @example
     * ```js
     * const http = require('http-call')
     * await http.get('https://google.com')
     * ```
     */
    value: function () {
      var _ref = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee(url) {
        var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
        var http;
        return _regenerator2.default.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                http = new this(url, { method: 'GET' }, options);
                _context.next = 3;
                return http.request();

              case 3:
                return _context.abrupt('return', http.body);

              case 4:
              case 'end':
                return _context.stop();
            }
          }
        }, _callee, this);
      }));

      function get(_x) {
        return _ref.apply(this, arguments);
      }

      return get;
    }()

    /**
     * make a streaming request
     * @param {string} url - url or path to call
     * @param {RequestOptions} options
     * @returns {Promise}
     * @example
     * ```js
     * const http = require('http-call')
     * let rsp = await http.get('https://google.com')
     * rsp.on('data', console.log)
     * ```
     */

  }, {
    key: 'stream',
    value: function () {
      var _ref2 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee2(url) {
        var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
        var http;
        return _regenerator2.default.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                http = new this(url, { method: 'GET', raw: true }, options);
                _context2.next = 3;
                return http.request();

              case 3:
                return _context2.abrupt('return', http.response);

              case 4:
              case 'end':
                return _context2.stop();
            }
          }
        }, _callee2, this);
      }));

      function stream(_x3) {
        return _ref2.apply(this, arguments);
      }

      return stream;
    }()
  }]);

  function HTTP(url) {
    (0, _classCallCheck3.default)(this, HTTP);
    this.method = 'GET';
    this.host = 'localhost';
    this.port = 0;
    this.protocol = 'https:';
    this.path = '/';
    this.raw = false;
    this.headers = {
      'user-agent': _package2.default.name + '/' + _package2.default.version + ' node-' + process.version
    };

    this.HTTPError = function (_Error) {
      (0, _inherits3.default)(HTTPError, _Error);

      function HTTPError(http, body) {
        (0, _classCallCheck3.default)(this, HTTPError);

        body = '\n' + _util2.default.inspect(body);

        var _this = (0, _possibleConstructorReturn3.default)(this, (HTTPError.__proto__ || (0, _getPrototypeOf2.default)(HTTPError)).call(this, 'HTTP Error ' + http.response.statusCode + ' for ' + http.method + ' ' + http.url + body));

        _this.statusCode = http.response.statusCode;
        return _this;
      }

      return HTTPError;
    }(Error);

    for (var _len = arguments.length, options = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
      options[_key - 1] = arguments[_key];
    }

    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = (0, _getIterator3.default)(options), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        var o = _step.value;
        this.addOptions(o);
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator.return) {
          _iterator.return();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    var u = _url2.default.parse(url);
    this.protocol = u.protocol || this.protocol;
    this.host = u.host || this.host;
    this.port = u.port || this.port || (this.protocol === 'https:' ? 443 : 80);
    this.path = u.path || this.path;
  }

  (0, _createClass3.default)(HTTP, [{
    key: 'addOptions',
    value: function addOptions(options) {
      var headers = (0, _assign2.default)(this.headers, options.headers);
      (0, _assign2.default)(this, options);
      this.headers = headers;
    }
  }, {
    key: 'request',
    value: function () {
      var _ref3 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee3() {
        return _regenerator2.default.wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                _context3.next = 2;
                return this.performRequest();

              case 2:
                this.response = _context3.sent;

                if (!(this.response.statusCode >= 200 && this.response.statusCode < 300)) {
                  _context3.next = 7;
                  break;
                }

                if (!this.raw) this.body = this.parse(this.response);
                _context3.next = 13;
                break;

              case 7:
                _context3.t0 = this.HTTPError;
                _context3.t1 = this;
                _context3.next = 11;
                return this.parse(this.response);

              case 11:
                _context3.t2 = _context3.sent;
                throw new _context3.t0(_context3.t1, _context3.t2);

              case 13:
              case 'end':
                return _context3.stop();
            }
          }
        }, _callee3, this);
      }));

      function request() {
        return _ref3.apply(this, arguments);
      }

      return request;
    }()
  }, {
    key: 'performRequest',
    value: function performRequest() {
      var _this2 = this;

      return new _promise2.default(function (resolve, reject) {
        var request = _this2.http.request(_this2, resolve);
        request.on('error', reject);
        request.end();
      });
    }
  }, {
    key: 'parse',
    value: function () {
      var _ref4 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee4(response) {
        var body;
        return _regenerator2.default.wrap(function _callee4$(_context4) {
          while (1) {
            switch (_context4.prev = _context4.next) {
              case 0:
                _context4.next = 2;
                return concat(response);

              case 2:
                body = _context4.sent;
                return _context4.abrupt('return', response.headers['content-type'] === 'application/json' ? JSON.parse(body) : body);

              case 4:
              case 'end':
                return _context4.stop();
            }
          }
        }, _callee4, this);
      }));

      function parse(_x5) {
        return _ref4.apply(this, arguments);
      }

      return parse;
    }()
  }, {
    key: 'http',
    get: function get() {
      return this.protocol === 'https:' ? _https2.default : _http2.default;
    }
  }, {
    key: 'url',
    get: function get() {
      return this.protocol + '//' + this.host + this.path;
    }
  }]);
  return HTTP;
}();

exports.default = HTTP;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9odHRwLmpzIl0sIm5hbWVzIjpbImNvbmNhdCIsInN0cmVhbSIsInN0cmluZ3MiLCJvbiIsInB1c2giLCJkYXRhIiwicmVzb2x2ZSIsImpvaW4iLCJIVFRQIiwidXJsIiwib3B0aW9ucyIsImh0dHAiLCJtZXRob2QiLCJyZXF1ZXN0IiwiYm9keSIsInJhdyIsInJlc3BvbnNlIiwiaG9zdCIsInBvcnQiLCJwcm90b2NvbCIsInBhdGgiLCJoZWFkZXJzIiwibmFtZSIsInZlcnNpb24iLCJwcm9jZXNzIiwiSFRUUEVycm9yIiwiaW5zcGVjdCIsInN0YXR1c0NvZGUiLCJFcnJvciIsIm8iLCJhZGRPcHRpb25zIiwidSIsInBhcnNlIiwicGVyZm9ybVJlcXVlc3QiLCJyZWplY3QiLCJlbmQiLCJKU09OIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBSUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBRUEsU0FBU0EsTUFBVCxDQUFpQkMsTUFBakIsRUFBeUI7QUFDdkIsU0FBTyxzQkFBWSxtQkFBVztBQUM1QixRQUFJQyxVQUFVLEVBQWQ7QUFDQUQsV0FBT0UsRUFBUCxDQUFVLE1BQVYsRUFBa0I7QUFBQSxhQUFRRCxRQUFRRSxJQUFSLENBQWFDLElBQWIsQ0FBUjtBQUFBLEtBQWxCO0FBQ0FKLFdBQU9FLEVBQVAsQ0FBVSxLQUFWLEVBQWlCO0FBQUEsYUFBTUcsUUFBUUosUUFBUUssSUFBUixDQUFhLEVBQWIsQ0FBUixDQUFOO0FBQUEsS0FBakI7QUFDRCxHQUpNLENBQVA7QUFLRDs7QUFLRDs7Ozs7OztBQXBCQTs7OztBQWtDQTs7OztJQUlNQyxJOzs7O0FBQ0o7Ozs7Ozs7Ozs7Ozs2RkFXa0JDLEc7WUFBS0MsTyx1RUFBVSxFOzs7Ozs7QUFDM0JDLG9CLEdBQU8sSUFBSSxJQUFKLENBQVNGLEdBQVQsRUFBYyxFQUFDRyxRQUFRLEtBQVQsRUFBZCxFQUErQkYs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cUNBVzVCO0FBQUE7O0FBQ2hCLGFBQU8sc0JBQVksVUFBQ1YsT0FBRCxFQUFVNEIsTUFBVixFQUFxQjtBQUN0QyxZQUFJckIsVUFBVSxPQUFLRixJQUFMLENBQVVFLE9BQVYsU0FBd0JQLE9BQXhCLENBQWQ7QUFDQU8sZ0JBQVFWLEVBQVIsQ0FBVyxPQUFYLEVBQW9CK0IsTUFBcEI7QUFDQXJCLGdCQUFRc0IsR0FBUjtBQUNELE9BSk0sQ0FBUDtBQUtEOzs7OytGQUVZbkIsUTs7Ozs7Ozt1QkFDTWhCLE9BQU9nQixRQUFQLEM7OztBQUFiRixvQjtrREFDR0UsU0FBU0ssT0FBVCxDQUFpQixjQUFqQixNQUFxQyxrQkFBckMsR0FDSGUsS0FBS0osS0FBTCxDQUFXbEIsSUFBWCxDQURHLEdBQ2dCQSxJOzs7Ozs7Ozs7Ozs7Ozs7Ozs7d0JBbkJpQjtBQUN4QyxhQUFPLEtBQUtLLFFBQUwsS0FBa0IsUUFBbEIsbUNBQVA7QUFDRDs7O3dCQUVrQjtBQUNqQixhQUFVLEtBQUtBLFFBQWYsVUFBNEIsS0FBS0YsSUFBakMsR0FBd0MsS0FBS0csSUFBN0M7QUFDRDs7Ozs7a0JBMkJZWixJIiwiZmlsZSI6Imh0dHAuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuLyogZ2xvYmFsXG4gIGh0dHAkSW5jb21pbmdNZXNzYWdlXG4qL1xuaW1wb3J0IHV0aWwgZnJvbSAndXRpbCdcbmltcG9ydCB1cmkgZnJvbSAndXJsJ1xuaW1wb3J0IHBqc29uIGZyb20gJy4uL3BhY2thZ2UuanNvbidcbmltcG9ydCBodHRwIGZyb20gJ2h0dHAnXG5pbXBvcnQgaHR0cHMgZnJvbSAnaHR0cHMnXG5cbmZ1bmN0aW9uIGNvbmNhdCAoc3RyZWFtKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICBsZXQgc3RyaW5ncyA9IFtdXG4gICAgc3RyZWFtLm9uKCdkYXRhJywgZGF0YSA9PiBzdHJpbmdzLnB1c2goZGF0YSkpXG4gICAgc3RyZWFtLm9uKCdlbmQnLCAoKSA9PiByZXNvbHZlKHN0cmluZ3Muam9pbignJykpKVxuICB9KVxufVxuXG50eXBlIE1ldGhvZCA9IHwgXCJHRVRcIiB8IFwiUE9TVFwiIHwgXCJQQVRDSFwiIHwgXCJQVVRcIiB8IFwiREVMRVRFXCJcbnR5cGUgSGVhZGVycyA9IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gUmVxdWVzdE9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7T2JqZWN0LjxzdHJpbmcsIHN0cmluZz59IGhlYWRlcnMgLSByZXF1ZXN0IGhlYWRlcnNcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBtZXRob2QgLSByZXF1ZXN0IG1ldGhvZCAoR0VUL1BPU1QvZXRjKVxuICogQHByb3BlcnR5IHsoc3RyaW5nKX0gYm9keSAtIHJlcXVlc3QgYm9keS4gU2V0cyBjb250ZW50LXR5cGUgdG8gYXBwbGljYXRpb24vanNvbiBhbmQgc3RyaW5naWZpZXMgd2hlbiBvYmplY3RcbiAqL1xudHlwZSBSZXF1ZXN0T3B0aW9ucyA9IHtcbiAgaGVhZGVycz86IEhlYWRlcnNcbn1cblxudHlwZSBKc29uID0gfCBzdHJpbmcgfCBudW1iZXIgfCBib29sZWFuIHwgbnVsbCB8IEpzb25PYmplY3QgfCBKc29uQXJyYXlcbnR5cGUgSnNvbk9iamVjdCA9IHsgW2tleTpzdHJpbmddOiBKc29uIH1cbnR5cGUgSnNvbkFycmF5ID0gSnNvbltdXG5cbi8qKlxuICogVXRpbGl0eSBmb3Igc2ltcGxlIEhUVFAgY2FsbHNcbiAqIEBjbGFzc1xuICovXG5jbGFzcyBIVFRQIHtcbiAgLyoqXG4gICAqIG1ha2UgYW4gaHR0cCBHRVQgcmVxdWVzdFxuICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gdXJsIG9yIHBhdGggdG8gY2FsbFxuICAgKiBAcGFyYW0ge1JlcXVlc3RPcHRpb25zfSBvcHRpb25zXG4gICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBqc1xuICAgKiBjb25zdCBodHRwID0gcmVxdWlyZSgnaHR0cC1jYWxsJylcbiAgICogYXdhaXQgaHR0cC5nZXQoJ2h0dHBzOi8vZ29vZ2xlLmNvbScpXG4gICAqIGBgYFxuICAgKi9cbiAgc3RhdGljIGFzeW5jIGdldCAodXJsLCBvcHRpb25zID0ge30pIHtcbiAgICBsZXQgaHR0cCA9IG5ldyB0aGlzKHVybCwge21ldGhvZDogJ0dFVCd9LCBvcHRpb25zKVxuICAgIGF3YWl0IGh0dHAucmVxdWVzdCgpXG4gICAgcmV0dXJuIGh0dHAuYm9keVxuICB9XG5cbiAgLyoqXG4gICAqIG1ha2UgYSBzdHJlYW1pbmcgcmVxdWVzdFxuICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gdXJsIG9yIHBhdGggdG8gY2FsbFxuICAgKiBAcGFyYW0ge1JlcXVlc3RPcHRpb25zfSBvcHRpb25zXG4gICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBqc1xuICAgKiBjb25zdCBodHRwID0gcmVxdWlyZSgnaHR0cC1jYWxsJylcbiAgICogbGV0IHJzcCA9IGF3YWl0IGh0dHAuZ2V0KCdodHRwczovL2dvb2dsZS5jb20nKVxuICAgKiByc3Aub24oJ2RhdGEnLCBjb25zb2xlLmxvZylcbiAgICogYGBgXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgc3RyZWFtICh1cmwsIG9wdGlvbnMgPSB7fSkge1xuICAgIGxldCBodHRwID0gbmV3IHRoaXModXJsLCB7bWV0aG9kOiAnR0VUJywgcmF3OiB0cnVlfSwgb3B0aW9ucylcbiAgICBhd2FpdCBodHRwLnJlcXVlc3QoKVxuICAgIHJldHVybiBodHRwLnJlc3BvbnNlXG4gIH1cblxuICBtZXRob2Q6IE1ldGhvZCA9ICdHRVQnXG4gIGhvc3QgPSAnbG9jYWxob3N0J1xuICBwb3J0ID0gMFxuICBwcm90b2NvbCA9ICdodHRwczonXG4gIHBhdGggPSAnLydcbiAgcmF3ID0gZmFsc2VcbiAgaGVhZGVyczogSGVhZGVycyA9IHtcbiAgICAndXNlci1hZ2VudCc6IGAke3Bqc29uLm5hbWV9LyR7cGpzb24udmVyc2lvbn0gbm9kZS0ke3Byb2Nlc3MudmVyc2lvbn1gXG4gIH1cbiAgcmVzcG9uc2U6IGh0dHAkSW5jb21pbmdNZXNzYWdlXG4gIGJvZHk6IEpzb25cblxuICBjb25zdHJ1Y3RvciAodXJsOiBzdHJpbmcsIC4uLm9wdGlvbnM6IFJlcXVlc3RPcHRpb25zW10pIHtcbiAgICBmb3IgKGxldCBvIG9mIG9wdGlvbnMpIHRoaXMuYWRkT3B0aW9ucyhvKVxuICAgIGxldCB1ID0gdXJpLnBhcnNlKHVybClcbiAgICB0aGlzLnByb3RvY29sID0gdS5wcm90b2NvbCB8fCB0aGlzLnByb3RvY29sXG4gICAgdGhpcy5ob3N0ID0gdS5ob3N0IHx8IHRoaXMuaG9zdFxuICAgIHRoaXMucG9ydCA9IHUucG9ydCB8fCB0aGlzLnBvcnQgfHwgKHRoaXMucHJvdG9jb2wgPT09ICdodHRwczonID8gNDQzIDogODApXG4gICAgdGhpcy5wYXRoID0gdS5wYXRoIHx8IHRoaXMucGF0aFxuICB9XG5cbiAgYWRkT3B0aW9ucyAob3B0aW9uczogUmVxdWVzdE9wdGlvbnMpIHtcbiAgICBsZXQgaGVhZGVycyA9IE9iamVjdC5hc3NpZ24odGhpcy5oZWFkZXJzLCBvcHRpb25zLmhlYWRlcnMpXG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLCBvcHRpb25zKVxuICAgIHRoaXMuaGVhZGVycyA9IGhlYWRlcnNcbiAgfVxuXG4gIGFzeW5jIHJlcXVlc3QgKCkge1xuICAgIHRoaXMucmVzcG9uc2UgPSBhd2FpdCB0aGlzLnBlcmZvcm1SZXF1ZXN0KClcbiAgICBpZiAodGhpcy5yZXNwb25zZS5zdGF0dXNDb2RlID49IDIwMCAmJiB0aGlzLnJlc3BvbnNlLnN0YXR1c0NvZGUgPCAzMDApIHtcbiAgICAgIGlmICghdGhpcy5yYXcpIHRoaXMuYm9keSA9IHRoaXMucGFyc2UodGhpcy5yZXNwb25zZSlcbiAgICB9IGVsc2UgdGhyb3cgbmV3IHRoaXMuSFRUUEVycm9yKHRoaXMsIGF3YWl0IHRoaXMucGFyc2UodGhpcy5yZXNwb25zZSkpXG4gIH1cblxuICBnZXQgaHR0cCAoKTogKHR5cGVvZiBodHRwIHwgdHlwZW9mIGh0dHBzKSB7XG4gICAgcmV0dXJuIHRoaXMucHJvdG9jb2wgPT09ICdodHRwczonID8gaHR0cHMgOiBodHRwXG4gIH1cblxuICBnZXQgdXJsICgpOiBzdHJpbmcge1xuICAgIHJldHVybiBgJHt0aGlzLnByb3RvY29sfS8vJHt0aGlzLmhvc3R9JHt0aGlzLnBhdGh9YFxuICB9XG5cbiAgcGVyZm9ybVJlcXVlc3QgKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBsZXQgcmVxdWVzdCA9IHRoaXMuaHR0cC5yZXF1ZXN0KHRoaXMsIHJlc29sdmUpXG4gICAgICByZXF1ZXN0Lm9uKCdlcnJvcicsIHJlamVjdClcbiAgICAgIHJlcXVlc3QuZW5kKClcbiAgICB9KVxuICB9XG5cbiAgYXN5bmMgcGFyc2UgKHJlc3BvbnNlOiBodHRwJEluY29taW5nTWVzc2FnZSkge1xuICAgIGxldCBib2R5ID0gYXdhaXQgY29uY2F0KHJlc3BvbnNlKVxuICAgIHJldHVybiByZXNwb25zZS5oZWFkZXJzWydjb250ZW50LXR5cGUnXSA9PT0gJ2FwcGxpY2F0aW9uL2pzb24nXG4gICAgICA/IEpTT04ucGFyc2UoYm9keSkgOiBib2R5XG4gIH1cblxuICBIVFRQRXJyb3IgPSBjbGFzcyBIVFRQRXJyb3IgZXh0ZW5kcyBFcnJvciB7XG4gICAgc3RhdHVzQ29kZTogbnVtYmVyXG5cbiAgICBjb25zdHJ1Y3RvciAoaHR0cDogSFRUUCwgYm9keTogSnNvbikge1xuICAgICAgYm9keSA9IGBcXG4ke3V0aWwuaW5zcGVjdChib2R5KX1gXG4gICAgICBzdXBlcihgSFRUUCBFcnJvciAke2h0dHAucmVzcG9uc2Uuc3RhdHVzQ29kZX0gZm9yICR7aHR0cC5tZXRob2R9ICR7aHR0cC51cmx9JHtib2R5fWApXG4gICAgICB0aGlzLnN0YXR1c0NvZGUgPSBodHRwLnJlc3BvbnNlLnN0YXR1c0NvZGVcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgSFRUUFxuIl19